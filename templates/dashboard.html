<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CIT Class Routine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
            color: white;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            display: block;
            border-bottom: 1px solid #34495e;
            cursor: pointer;
        }
        .sidebar a:hover {
            background: #34495e;
        }
        .sidebar a.active {
            background: #667eea;
        }
        .user-info {
            padding: 20px;
            background: #1a252f;
            text-align: center;
        }
        .role-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .role-admin { background: #e74c3c; }
        .role-teacher { background: #3498db; }
        .role-cr { background: #9b59b6; }
        .role-student { background: #27ae60; }
    </style>
    </head>
    <body data-current-user-branch-id="{{ current_user.branch_id or '' }}" data-current-user-is-admin="{{ '1' if current_user.is_admin() else '0' }}">
</head>
<body data-current-user-branch-id="{{ current_user.branch_id or '' }}" data-current-user-is-admin="{{ '1' if current_user.is_admin() else '0' }}">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0">
                <div class="user-info">
                    <h5>{{ current_user.username }}</h5>
                    <span class="role-badge role-{{ current_user.role }}">{{ current_user.role }}</span>
                    {% if current_user.branch %}
                    <br><small>{{ current_user.branch.name }}</small>
                    {% endif %}
                </div>
                <a href="{{ url_for('dashboard') }}" class="active">üìÖ Class Routine</a>
                
                {% if current_user.is_admin() %}
                <a onclick="showModal('branchesModal')">üè¢ Branches</a>
                <a onclick="showModal('yearsModal')">üìö Years</a>
                <a onclick="showModal('modulesModal')">üìñ Modules</a>
                <a onclick="showModal('instructorsModal')">üë®‚Äçüè´ Instructors</a>
                <a onclick="showModal('roomsModal')">üè† Rooms</a>
                <a onclick="showModal('usersModal')">üë• Users</a>
                {% endif %}
                
                <a href="{{ url_for('logout') }}" class="text-danger">üö™ Logout</a>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <h2 class="mb-4">Class Routine Management</h2>
                
                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="GET" action="{{ url_for('dashboard') }}" class="row g-3">
                            {% if current_user.is_admin() %}
                            <div class="col-md-3">
                                <label class="form-label">Branch</label>
                                <select class="form-select" name="branch_id">
                                    <option value="">All Branches</option>
                                    {% for branch in branches %}
                                    <option value="{{ branch.id }}" {% if current_branch_id == branch.id|string %}selected{% endif %}>
                                        {{ branch.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Year</label>
                                <select class="form-select" name="year_id">
                                    <option value="">All Years</option>
                                    {% for year in years %}
                                    <option value="{{ year.id }}" {% if current_year_id == year.id|string %}selected{% endif %}>
                                        {{ year.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            <div class="col-md-3">
                                <label class="form-label">Day</label>
                                <select class="form-select" name="day">
                                    <option value="">All Days</option>
                                    <option value="Monday" {% if current_day == 'Monday' %}selected{% endif %}>Monday</option>
                                    <option value="Tuesday" {% if current_day == 'Tuesday' %}selected{% endif %}>Tuesday</option>
                                    <option value="Wednesday" {% if current_day == 'Wednesday' %}selected{% endif %}>Wednesday</option>
                                    <option value="Thursday" {% if current_day == 'Thursday' %}selected{% endif %}>Thursday</option>
                                    <option value="Friday" {% if current_day == 'Friday' %}selected{% endif %}>Friday</option>
                                    <option value="Saturday" {% if current_day == 'Saturday' %}selected{% endif %}>Saturday</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">Filter</button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Reset</a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Add Class Button -->
                {% if not current_user.is_student() %}
                <div class="mb-3">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addClassModal">
                        ‚ûï Add New Class
                    </button>
                </div>
                {% endif %}
                
                <!-- Class Table -->
                <div class="card">
                    <div class="card-body">
                        <table class="table table-striped" id="classesTable">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Subject</th>
                                    <th>Room</th>
                                    <th>Instructor</th>
                                    <th>Module</th>
                                    <th>Branch</th>
                                    {% if not current_user.is_student() %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody id="classesTableBody">
                                {% for cls in classes %}
                                <tr>
                                    <td>{{ cls.day }}</td>
                                    <td>{{ cls.start_time.strftime('%H:%M') }} - {{ cls.end_time.strftime('%H:%M') }}</td>
                                    <td>{{ cls.subject }}</td>
                                    <td>{{ cls.room.name if cls.room else '-' }}</td>
                                    <td>{{ cls.instructor.name if cls.instructor else '-' }}</td>
                                    <td>{{ cls.module.name if cls.module else '-' }}</td>
                                    <td>{{ cls.branch.name if cls.branch else '-' }}</td>
                                    {% if not current_user.is_student() %}
                                    <td>
                                        <button class="btn btn-sm btn-primary" data-id="{{ cls.id }}" onclick="editClass(this.dataset.id)">‚úèÔ∏è Edit</button>
                                        <button class="btn btn-sm btn-danger" data-id="{{ cls.id }}" onclick="deleteClass(this.dataset.id)">üóëÔ∏è Delete</button>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">No classes found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Class Modal -->
    <div class="modal fade" id="addClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addClassForm">
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" id="addSubject" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="addStartTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" id="addEndTime" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Day</label>
                            <select class="form-select" id="addDay" required>
                                <option value="">Select Day</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                            </select>
                        </div>
                        {% if current_user.is_admin() %}
                        <div class="mb-3">
                            <label class="form-label">Branch</label>
                            <select class="form-select" id="addBranchId" required>
                                <option value="">Select Branch</option>
                                {% for branch in branches %}
                                <option value="{{ branch.id }}">{{ branch.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <label class="form-label">Module</label>
                            <select class="form-select" id="addModuleId">
                                <option value="">Select Module</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Instructor</label>
                            <select class="form-select" id="addInstructorId">
                                <option value="">Select Instructor</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Room</label>
                            <select class="form-select" id="addRoomId">
                                <option value="">Select Room</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addClass()">Add Class</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Class Modal -->
    <div class="modal fade" id="editClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editClassForm">
                        <input type="hidden" id="editClassId">
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" id="editSubject" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="editStartTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" id="editEndTime" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Day</label>
                            <select class="form-select" id="editDay" required>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Module</label>
                            <select class="form-select" id="editModuleId"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Instructor</label>
                            <select class="form-select" id="editInstructorId"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Room</label>
                            <select class="form-select" id="editRoomId"></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateClass()">Update Class</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Branches Modal -->
    <div class="modal fade" id="branchesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Branches</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="branchName" placeholder="Branch Name">
                        <input type="text" class="form-control mt-2" id="branchCode" placeholder="Branch Code">
                        <button class="btn btn-primary mt-2" onclick="addBranch()">Add Branch</button>
                    </div>
                    <table class="table table-striped">
                        <thead><tr><th>Name</th><th>Code</th><th>Actions</th></tr></thead>
                        <tbody id="branchesList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Years Modal -->
    <div class="modal fade" id="yearsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Years</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="yearName" placeholder="Year Name (e.g., 1st Year)">
                        <button class="btn btn-primary mt-2" onclick="addYear()">Add Year</button>
                    </div>
                    <table class="table table-striped">
                        <thead><tr><th>Name</th><th>Actions</th></tr></thead>
                        <tbody id="yearsList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modules Modal -->
    <div class="modal fade" id="modulesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Modules/Semesters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="moduleName" placeholder="Module Name">
                        <select class="form-select mt-2" id="moduleYearId">
                            <option value="">Select Year</option>
                        </select>
                        <button class="btn btn-primary mt-2" onclick="addModule()">Add Module</button>
                    </div>
                    <table class="table table-striped">
                        <thead><tr><th>Name</th><th>Year</th><th>Actions</th></tr></thead>
                        <tbody id="modulesList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Instructors Modal -->
    <div class="modal fade" id="instructorsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Instructors</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="instructorName" placeholder="Instructor Name">
                        <input type="email" class="form-control mt-2" id="instructorEmail" placeholder="Email">
                        <input type="text" class="form-control mt-2" id="instructorPhone" placeholder="Phone">
                        <select class="form-select mt-2" id="instructorBranchId">
                            <option value="">Select Branch</option>
                        </select>
                        <button class="btn btn-primary mt-2" onclick="addInstructor()">Add Instructor</button>
                    </div>
                    <table class="table table-striped">
                        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Branch</th><th>Actions</th></tr></thead>
                        <tbody id="instructorsList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rooms Modal -->
    <div class="modal fade" id="roomsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Rooms</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="roomName" placeholder="Room Name">
                        <input type="text" class="form-control mt-2" id="roomBuilding" placeholder="Building">
                        <input type="number" class="form-control mt-2" id="roomCapacity" placeholder="Capacity">
                        <button class="btn btn-primary mt-2" onclick="addRoom()">Add Room</button>
                    </div>
                    <table class="table table-striped">
                        <thead><tr><th>Name</th><th>Building</th><th>Capacity</th><th>Actions</th></tr></thead>
                        <tbody id="roomsList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Modal -->
    <div class="modal fade" id="usersModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Users</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-striped">
                        <thead><tr><th>Username</th><th>Role</th><th>Branch</th><th>Year</th></tr></thead>
                        <tbody id="usersList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let dropdownData = {};
        const CURRENT_USER_BRANCH_ID = document.body.dataset.currentUserBranchId ? Number(document.body.dataset.currentUserBranchId) : null;
        const CURRENT_USER_IS_ADMIN = document.body.dataset.currentUserIsAdmin === '1';
        
        function showModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
            
            if (modalId === 'branchesModal') loadBranches();
            if (modalId === 'yearsModal') loadYears();
            if (modalId === 'modulesModal') loadModules();
            if (modalId === 'instructorsModal') loadInstructors();
            if (modalId === 'roomsModal') loadRooms();
            if (modalId === 'usersModal') loadUsers();
        }
        
        async function loadDropdownData() {
            const response = await fetch('/api/dropdown-data');
            dropdownData = await response.json();
            
            const moduleSelect = document.getElementById('addModuleId');
            dropdownData.modules.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name;
                moduleSelect.appendChild(opt);
            });
            
            const instructorSelect = document.getElementById('addInstructorId');
            dropdownData.instructors.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.id;
                opt.textContent = i.name;
                instructorSelect.appendChild(opt);
            });
            
            const roomSelect = document.getElementById('addRoomId');
            dropdownData.rooms.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.name + ' (' + r.building + ')';
                roomSelect.appendChild(opt);
            });
            
            // Populate year dropdown for modules
            const moduleYearSelect = document.getElementById('moduleYearId');
            dropdownData.years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y.id;
                opt.textContent = y.name;
                moduleYearSelect.appendChild(opt);
            });
            
            // Populate branch dropdown for instructors
            const instructorBranchSelect = document.getElementById('instructorBranchId');
            dropdownData.branches.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.name;
                instructorBranchSelect.appendChild(opt);
            });
        }
        
        // Class functions
        async function addClass() {
            let branchId = CURRENT_USER_IS_ADMIN ? document.getElementById('addBranchId').value : CURRENT_USER_BRANCH_ID;
            
            const data = {
                subject: document.getElementById('addSubject').value,
                start_time: document.getElementById('addStartTime').value,
                end_time: document.getElementById('addEndTime').value,
                day: document.getElementById('addDay').value,
                module_id: document.getElementById('addModuleId').value || null,
                instructor_id: document.getElementById('addInstructorId').value || null,
                room_id: document.getElementById('addRoomId').value || null,
                branch_id: branchId
            };
            
            const response = await fetch('/api/classes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Class added successfully!');
                location.reload();
            } else {
                const result = await response.json();
                alert('Error: ' + result.error);
            }
        }
        
        async function editClass(id) {
            id = Number(id);
            const response = await fetch('/api/classes');
            const classes = await response.json();
            const cls = classes.find(c => c.id === id);
            
            if (cls) {
                document.getElementById('editClassId').value = cls.id;
                document.getElementById('editSubject').value = cls.subject;
                document.getElementById('editStartTime').value = cls.start_time;
                document.getElementById('editEndTime').value = cls.end_time;
                document.getElementById('editDay').value = cls.day;
                
                const editModuleSelect = document.getElementById('editModuleId');
                editModuleSelect.innerHTML = '<option value="">Select Module</option>';
                dropdownData.modules.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.name;
                    editModuleSelect.appendChild(opt);
                });
                
                const editInstructorSelect = document.getElementById('editInstructorId');
                editInstructorSelect.innerHTML = '<option value="">Select Instructor</option>';
                dropdownData.instructors.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i.id;
                    opt.textContent = i.name;
                    editInstructorSelect.appendChild(opt);
                });
                
                const editRoomSelect = document.getElementById('editRoomId');
                editRoomSelect.innerHTML = '<option value="">Select Room</option>';
                dropdownData.rooms.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.textContent = r.name + ' (' + r.building + ')';
                    editRoomSelect.appendChild(opt);
                });
                
                const editModal = new bootstrap.Modal(document.getElementById('editClassModal'));
                editModal.show();
            }
        }
        
        async function updateClass() {
            const id = Number(document.getElementById('editClassId').value);
            let branchId = CURRENT_USER_IS_ADMIN ? document.getElementById('editBranchId')?.value || CURRENT_USER_BRANCH_ID : CURRENT_USER_BRANCH_ID;
            
            const data = {
                subject: document.getElementById('editSubject').value,
                start_time: document.getElementById('editStartTime').value,
                end_time: document.getElementById('editEndTime').value,
                day: document.getElementById('editDay').value,
                module_id: document.getElementById('editModuleId').value || null,
                instructor_id: document.getElementById('editInstructorId').value || null,
                room_id: document.getElementById('editRoomId').value || null,
                branch_id: branchId || 1
            };
            
            const response = await fetch('/api/classes/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Class updated successfully!');
                location.reload();
            } else {
                const result = await response.json();
                alert('Error: ' + result.error);
            }
        }
        
        async function deleteClass(id) {
            id = Number(id);
            if (!confirm('Are you sure you want to delete this class?')) return;
            
            const response = await fetch('/api/classes/' + id, { method: 'DELETE' });
            
            if (response.ok) {
                alert('Class deleted successfully!');
                location.reload();
            } else {
                const result = await response.json();
                alert('Error: ' + result.error);
            }
        }
        
        // Branch functions
        async function loadBranches() {
            const response = await fetch('/api/branches');
            const branches = await response.json();
            const tbody = document.getElementById('branchesList');
            tbody.innerHTML = branches.map(b => `<tr><td>${b.name}</td><td>${b.code}</td><td><button class="btn btn-sm btn-danger" data-id="${b.id}" onclick="deleteBranch(this.dataset.id)">Delete</button></td></tr>`).join('');
        }
        
        async function addBranch() {
            const data = { name: document.getElementById('branchName').value, code: document.getElementById('branchCode').value };
            await fetch('/api/branches', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            document.getElementById('branchName').value = '';
            document.getElementById('branchCode').value = '';
            loadBranches();
            loadDropdownData();
        }
        
        async function deleteBranch(id) {
            id = Number(id);
            if (!confirm('Delete this branch?')) return;
            await fetch('/api/branches/' + id, { method: 'DELETE' });
            loadBranches();
        }
        
        // Year functions
        async function loadYears() {
            const response = await fetch('/api/years');
            const years = await response.json();
            const tbody = document.getElementById('yearsList');
            tbody.innerHTML = years.map(y => `<tr><td>${y.name}</td><td><button class="btn btn-sm btn-danger" data-id="${y.id}" onclick="deleteYear(this.dataset.id)">Delete</button></td></tr>`).join('');
        }
        
        async function addYear() {
            const data = { name: document.getElementById('yearName').value };
            await fetch('/api/years', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            document.getElementById('yearName').value = '';
            loadYears();
            loadDropdownData();
        }
        
        async function deleteYear(id) {
            id = Number(id);
            if (!confirm('Delete this year?')) return;
            await fetch('/api/years/' + id, { method: 'DELETE' });
            loadYears();
        }
        
        // Module functions
        async function loadModules() {
            const response = await fetch('/api/modules');
            const modules = await response.json();
            const tbody = document.getElementById('modulesList');
            tbody.innerHTML = modules.map(m => `<tr><td>${m.name}</td><td>${m.year_name}</td><td><button class="btn btn-sm btn-danger" data-id="${m.id}" onclick="deleteModule(this.dataset.id)">Delete</button></td></tr>`).join('');
        }
        
        async function addModule() {
            const data = { name: document.getElementById('moduleName').value, year_id: document.getElementById('moduleYearId').value };
            await fetch('/api/modules', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            document.getElementById('moduleName').value = '';
            loadModules();
            loadDropdownData();
        }
        
        async function deleteModule(id) {
            id = Number(id);
            if (!confirm('Delete this module?')) return;
            await fetch('/api/modules/' + id, { method: 'DELETE' });
            loadModules();
        }
        
        // Instructor functions
        async function loadInstructors() {
            const response = await fetch('/api/instructors');
            const instructors = await response.json();
            const tbody = document.getElementById('instructorsList');
            tbody.innerHTML = instructors.map(i => `<tr><td>${i.name}</td><td>${i.email || '-'}</td><td>${i.phone || '-'}</td><td>${i.branch_name || '-'}</td><td><button class="btn btn-sm btn-danger" data-id="${i.id}" onclick="deleteInstructor(this.dataset.id)">Delete</button></td></tr>`).join('');
        }
        
        async function addInstructor() {
            const data = {
                name: document.getElementById('instructorName').value,
                email: document.getElementById('instructorEmail').value,
                phone: document.getElementById('instructorPhone').value,
                branch_id: document.getElementById('instructorBranchId').value || null
            };
            await fetch('/api/instructors', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            document.getElementById('instructorName').value = '';
            document.getElementById('instructorEmail').value = '';
            document.getElementById('instructorPhone').value = '';
            loadInstructors();
            loadDropdownData();
        }
        
        async function deleteInstructor(id) {
            id = Number(id);
            if (!confirm('Delete this instructor?')) return;
            await fetch('/api/instructors/' + id, { method: 'DELETE' });
            loadInstructors();
        }
        
        // Room functions
        async function loadRooms() {
            const response = await fetch('/api/rooms');
            const rooms = await response.json();
            const tbody = document.getElementById('roomsList');
            tbody.innerHTML = rooms.map(r => `<tr><td>${r.name}</td><td>${r.building || '-'}</td><td>${r.capacity}</td><td><button class="btn btn-sm btn-danger" data-id="${r.id}" onclick="deleteRoom(this.dataset.id)">Delete</button></td></tr>`).join('');
        }
        
        async function addRoom() {
            const data = {
                name: document.getElementById('roomName').value,
                building: document.getElementById('roomBuilding').value,
                capacity: document.getElementById('roomCapacity').value || 0
            };
            await fetch('/api/rooms', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            document.getElementById('roomName').value = '';
            document.getElementById('roomBuilding').value = '';
            document.getElementById('roomCapacity').value = '';
            loadRooms();
            loadDropdownData();
        }
        
        async function deleteRoom(id) {
            id = Number(id);
            if (!confirm('Delete this room?')) return;
            await fetch('/api/rooms/' + id, { method: 'DELETE' });
            loadRooms();
        }
        
        // User functions
        async function loadUsers() {
            const response = await fetch('/api/users');
            const users = await response.json();
            const tbody = document.getElementById('usersList');
            tbody.innerHTML = users.map(u => `<tr><td>${u.username}</td><td>${u.role}</td><td>${u.branch_name || '-'}</td><td>${u.year_name || '-'}</td></tr>`).join('');
        }
        
        loadDropdownData();
    </script>
</body>
</html>
